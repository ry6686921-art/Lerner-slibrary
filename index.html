<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agniveer Vayu â€“ Ultimate CBT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"
onload="renderMath()"></script>

<style>
:root{
 --primary:#0a3d62;--secondary:#576574;--success:#10ac84;
 --danger:#ee5253;--purple:#5f27cd;--warning:#f39c12;--bg:#f1f2f6;
}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);margin:0}
.hidden{display:none}.center{text-align:center}

.header{
 background:var(--primary);color:#fff;padding:10px 20px;
 display:flex;justify-content:space-between;align-items:center;
 border-bottom:3px solid #feca57;position:sticky;top:0;z-index:100
}
.timer{
 background:#fff;color:var(--danger);padding:5px 12px;
 border-radius:4px;font-weight:bold;border:2px solid var(--danger)
}

.card{
 background:#fff;padding:30px;border-radius:10px;
 box-shadow:0 6px 20px rgba(0,0,0,0.08);
 border:1px solid #ddd;margin-bottom:20px
}

button{
 padding:12px 18px;border:none;border-radius:6px;
 cursor:pointer;background:var(--primary);color:#fff;
 font-weight:600;margin:5px
}
button.secondary{background:var(--secondary)}
button.success{background:var(--success)}
button.danger{background:var(--danger)}
button.purple{background:var(--purple)}
button.warning{background:var(--warning)}

input{
 padding:14px;margin:10px 0;width:100%;
 border-radius:6px;border:1px solid #ccc;font-size:15px
}

.option{
 display:block;width:100%;margin:10px 0;padding:15px;
 border:2px solid #e9ecef;border-radius:6px;cursor:pointer
}
.option.selected{background:#e3f2fd;border-color:var(--primary);font-weight:bold}
.option.correct{background:#d4edda!important;border-color:#28a745}
.option.wrong{background:#f8d7da!important;border-color:#dc3545}

.palette-btn{
 width:40px;height:40px;margin:4px;border-radius:6px;
 border:1px solid #bbb;font-weight:bold;background:#eee;color:#333
}
.p-current{background:#3498db;color:#fff}
.p-attempted{background:#2ecc71;color:#fff}
.p-marked{border:3px solid var(--purple)}
.p-marked-attempted{background:var(--warning);color:#fff;border:3px solid var(--purple)}
</style>
</head>

<body>

<div id="examHeader" class="header hidden">
  <b id="candDisplay"></b>
  <div class="timer" id="timer">00:00</div>
</div>

<div class="container">

<div id="instructions" class="card center" style="max-width:700px;margin:40px auto">
  <h1>ðŸ‡®ðŸ‡³ Agniveer Vayu Ultimate CBT</h1>
  <h3 style="color:var(--secondary)">Rohit Sir â€“ Mock Master</h3>
  <hr>
  <ul style="text-align:left">
    <li>+1 for correct, âˆ’0.25 for wrong</li>
    <li>Mark questions for review</li>
    <li>Do not refresh during exam</li>
  </ul>
  <button onclick="show('login')">Proceed to Login</button>
</div>

<div id="login" class="card hidden" style="max-width:420px;margin:60px auto">
  <h2 class="center">Candidate Login</h2>
  <p class="center" style="color:#666">Enter registered details</p>
  <input id="sname" placeholder="ðŸ‘¤ Full Name">
  <input id="sphone" placeholder="ðŸ“± Phone Number">
  <button class="success" style="width:100%" onclick="startExam()">Start Examination</button>
</div>

<div id="exam" class="hidden">
  <div style="display:flex;gap:15px;flex-wrap:wrap">
    <div style="flex:3">
      <div class="card">
        <div id="qContainer"></div>
        <div class="center">
          <button class="secondary" onclick="prevQ()">â¬… Previous</button>
          <button class="purple" onclick="toggleMark()">ðŸ“Œ Mark</button>
          <button onclick="nextQ()">Save & Next âž¡</button>
          <button class="danger" id="submitBtn" onclick="confirmSubmit()">Final Submit</button>
          <button class="secondary hidden" id="exitReviewBtn" onclick="exitReview()">Exit Review</button>
        </div>
      </div>
    </div>

    <div style="flex:1">
      <div class="card">
        <h4>Question Palette</h4>
        <div id="palette"></div>
      </div>
    </div>
  </div>
</div>

<div id="result" class="card hidden center" style="max-width:700px;margin:40px auto">
  <div id="resultUI"></div>
</div>

</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwGCcxh5hD0uQWhm7vs83A-taQJVW-gNuvml56tvyEndii5Gwd3pBxmhqMcAUSuWrBW2Q/exec";

let questions=[],students=[],answers={},marked={},cur=0;
let time, timerInt, startTime, initialTime=1800; // time is now dynamic
let studentName="",studentPhone="",review=false;
let resultSaved=false;

window.onload=async()=>{
  const [qRes, sRes, setRes] = await Promise.all([
    fetch(SCRIPT_URL+"?action=getQuestions"),
    fetch(SCRIPT_URL+"?action=getStudents"),
    fetch(SCRIPT_URL+"?action=getSettings")
  ]);
  questions = await qRes.json();
  students = await sRes.json();
  const settings = await setRes.json();
  initialTime = (settings.time || 30) * 60; // Fetches time from Cloud Settings
  time = initialTime;
};

function startExam(){
  let u=students.find(s=>s.name.toLowerCase()==sname.value.toLowerCase()
    && s.phone==sphone.value);
  if(!u) return alert("Not registered");

  studentName=u.name;studentPhone=u.phone;
  candDisplay.innerText="CANDIDATE: "+studentName;
  show("exam");examHeader.classList.remove("hidden");
  startTime=Date.now();
  buildPalette();loadQ(0);startTimer();
}

function loadQ(i){
  cur=i;buildPalette();
  let q=questions[i];
  let h=`<h3>Q${i+1}. ${q.text}</h3>`;
  q.options.forEach((o,j)=>{
    let c="option";
    if(answers[i]==j)c+=" selected";
    if(review){
      if(j==q.correct)c+=" correct";
      else if(answers[i]==j)c+=" wrong";
    }
    h+=`<div class="${c}" onclick="selectA(${j})">${o}</div>`;
  });
  qContainer.innerHTML=h;renderMath();
}

function selectA(i){if(!review){answers[cur]=i;buildPalette();loadQ(cur);}}
function nextQ(){if(cur<questions.length-1)loadQ(cur+1);}
function prevQ(){if(cur>0)loadQ(cur-1);}
function toggleMark(){marked[cur]=!marked[cur];buildPalette();}

function buildPalette(){
  palette.innerHTML="";
  questions.forEach((_,i)=>{
    let b=document.createElement("button");
    b.innerText=i+1;b.className="palette-btn";
    const a=answers[i]!=null,m=marked[i];
    if(i===cur)b.classList.add("p-current");
    else if(a&&m)b.classList.add("p-marked-attempted");
    else if(a)b.classList.add("p-attempted");
    else if(m)b.classList.add("p-marked");
    b.onclick=()=>loadQ(i);
    palette.appendChild(b);
  });
}

function startTimer(){
  timerInt=setInterval(()=>{
    let m=Math.floor(time/60),s=time%60;
    timer.innerText=`${m}:${String(s).padStart(2,"0")}`;
    if(--time<0)submit();
  },1000);
}

function confirmSubmit(){if(confirm("Submit Exam?"))submit();}

async function submit(){
  if(resultSaved) return;
  resultSaved=true;
  clearInterval(timerInt);

  let correct=0,wrong=0;
  questions.forEach((q,i)=>{
    if(answers[i]==q.correct)correct++;
    else if(answers[i]!=null)wrong++;
  });

  let score=correct-wrong*0.25;

  await fetch(SCRIPT_URL,{method:"POST",mode:"no-cors",
    body:JSON.stringify({name:studentName,phone:studentPhone,
      score,correct,wrong})});

  resultUI.innerHTML=`
    <h2>Test Submitted</h2>
    <p><b>${studentName}</b></p>
    <h1>${score.toFixed(2)}</h1>
    <button class="warning" onclick="enterReview()">Review Answers</button>
  `;
  show("result");
}

function enterReview(){
  review=true;
  show("exam");
  loadQ(0);
  submitBtn.classList.add("hidden");
  exitReviewBtn.classList.remove("hidden");
}

function exitReview(){
  review=false;
  clearInterval(timerInt);
  answers={}; marked={}; cur=0; time=initialTime;
  examHeader.classList.add("hidden");
  submitBtn.classList.remove("hidden");
  exitReviewBtn.classList.add("hidden");
  show("instructions");
}

function show(id){
  document.querySelectorAll(".container>div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function renderMath(){
  if(window.renderMathInElement)
    renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true}]});
}
</script>

</body>
</html>
