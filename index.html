<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agniveer Vayu ‚Äì Ultimate CBT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" onload="renderMath()"></script>

<style>
:root{
 --primary:#0a3d62;--secondary:#576574;--success:#10ac84;
 --danger:#ee5253;--purple:#5f27cd;--warning:#f39c12;--bg:#f1f2f6;
}
body {
  font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0;
  -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
}
.watermark {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
  font-size: 6vw; color: rgba(0,0,0,0.05); font-weight: 900;
  pointer-events: none; z-index: 9999; white-space: nowrap; text-transform: uppercase;
  text-align: center; line-height: 1;
}
.hidden{display:none}.center{text-align:center}
.header{
 background:var(--primary);color:#fff;padding:10px 20px;
 display:flex;justify-content:space-between;align-items:center;
 border-bottom:3px solid #feca57;position:sticky;top:0;z-index:100
}
.timer{background:#fff;color:var(--danger);padding:5px 12px;border-radius:4px;font-weight:bold;border:2px solid var(--danger)}
.card{background:#fff;padding:30px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08);border:1px solid #ddd;margin-bottom:20px}
button{padding:12px 18px;border:none;border-radius:6px;cursor:pointer;background:var(--primary);color:#fff;font-weight:600;margin:5px}
button.secondary{background:var(--secondary)}
button.success{background:var(--success)}
button.danger{background:var(--danger)}
button.purple{background:var(--purple)}
button.warning{background:var(--warning)}
input{padding:14px;margin:10px 0;width:100%;border-radius:6px;border:1px solid #ccc;font-size:15px}
.option{display:block;width:100%;margin:10px 0;padding:15px;border:2px solid #e9ecef;border-radius:6px;cursor:pointer}
.option.selected{background:#e3f2fd;border-color:var(--primary);font-weight:bold}
.option.correct{background:#d4edda!important;border-color:#28a745}
.option.wrong{background:#f8d7da!important;border-color:#dc3545}
.palette-btn{width:40px;height:40px;margin:4px;border-radius:6px;border:1px solid #bbb;font-weight:bold;background:#eee;color:#333}
.p-current{background:#3498db;color:#fff}
.p-attempted{background:#2ecc71;color:#fff}
.p-marked{border:3px solid var(--purple)}
.p-marked-attempted{background:var(--warning);color:#fff;border:3px solid var(--purple)}

/* Insight Styling */
.insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
.insight-box { padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 5px solid var(--primary); }
.insight-box h4 { margin: 0; color: var(--secondary); font-size: 0.9em; }
.insight-box p { margin: 5px 0 0; font-size: 1.4em; font-weight: bold; color: var(--primary); }
</style>
</head>

<body oncontextmenu="return false" ondragstart="return false">

<div class="watermark" id="brandMark">ROHIT SIR</div>

<div id="examHeader" class="header hidden">
  <b id="candDisplay"></b>
  <div class="timer" id="timer">00:00</div>
</div>

<div class="container" style="position: relative; z-index: 1;">

<div id="instructions" class="card center" style="max-width:700px;margin:40px auto">
  <h1>üáÆüá≥ Rohit Sir ‚Äì CBT Master</h1>
  <h3 style="color:var(--secondary)">Quality Coaching, Superior Testing</h3>
  <hr>
  <ul style="text-align:left">
    <li>+1 for correct, ‚àí0.25 for wrong</li>
    <li>Mark questions for review using the üìå Mark button</li>
    <li>Tab switching and right-clicks are strictly prohibited</li>
  </ul>
  <button onclick="show('login')">Proceed to Login</button>
</div>

<div id="login" class="card hidden" style="max-width:420px;margin:60px auto">
  <h2 class="center">Candidate Login</h2>
  <input id="sname" placeholder="üë§ Full Name">
  <input id="sphone" placeholder="üì± Phone Number">
  <button class="success" style="width:100%" onclick="startExam()">Start Examination</button>
</div>

<div id="exam" class="hidden">
  <div style="display:flex;gap:15px;flex-wrap:wrap">
    <div style="flex:3">
      <div class="card">
        <div id="qContainer"></div>
        <div class="center">
          <button class="secondary" onclick="prevQ()">‚¨Ö Previous</button>
          <button class="purple" onclick="toggleMark()">üìå Mark</button>
          <button onclick="nextQ()">Save & Next ‚û°</button>
          <button class="danger" id="submitBtn" onclick="confirmSubmit()">Final Submit</button>
          <button class="secondary hidden" id="exitReviewBtn" onclick="location.reload()">Exit to Home</button>
        </div>
      </div>
    </div>
    <div style="flex:1">
      <div class="card">
        <h4>Question Palette</h4>
        <div id="palette"></div>
      </div>
    </div>
  </div>
</div>

<div id="result" class="card hidden center" style="max-width:700px;margin:40px auto">
  <div id="resultUI"></div>
</div>

</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbwGCcxh5hD0uQWhm7vs83A-taQJVW-gNuvml56tvyEndii5Gwd3pBxmhqMcAUSuWrBW2Q/exec";

let questions=[],students=[],answers={},marked={},cur=0;
let time, timerInt, startTime, initialTime=1800;
let studentName="",studentPhone="",review=false;
let resultSaved=false;

document.addEventListener('keydown', e => {
  if (e.ctrlKey && (e.key==='u'||e.key==='c'||e.key==='v'||e.key==='s'||e.key==='p')) e.preventDefault();
  if (e.keyCode === 123) e.preventDefault(); 
});

document.addEventListener("visibilitychange", () => {
  if (document.hidden && !resultSaved && studentName !== "") {
    alert("Warning: Unauthorized tab switching! This activity is logged.");
  }
});

window.onload=async()=>{
  const [qRes, sRes, setRes] = await Promise.all([
    fetch(SCRIPT_URL+"?action=getQuestions"),
    fetch(SCRIPT_URL+"?action=getStudents"),
    fetch(SCRIPT_URL+"?action=getSettings")
  ]);
  questions = await qRes.json();
  students = await sRes.json();
  const settings = await setRes.json();
  initialTime = (settings.time || 30) * 60;
  time = initialTime;
};

function startExam(){
  let u=students.find(s=>s.name.toLowerCase()==sname.value.toLowerCase().trim()
    && s.phone==sphone.value.trim());
  if(!u) return alert("Phone number or Name not registered by Rohit Sir.");
  studentName=u.name;studentPhone=u.phone;
  brandMark.innerHTML = `ROHIT SIR<br><span style="font-size:2vw">${studentPhone}</span>`;
  candDisplay.innerText="CANDIDATE: "+studentName;
  show("exam");examHeader.classList.remove("hidden");
  startTime=Date.now();
  buildPalette();loadQ(0);startTimer();
}

function loadQ(i){
  cur=i;buildPalette();
  let q=questions[i];
  let h=`<h3>Q${i+1}. ${q.text}</h3>`;
  if(q.img) h += `<img src="${q.img}" style="max-width:100%;"><br>`;
  q.options.forEach((o,j)=>{
    let c="option";
    if(answers[i]==j)c+=" selected";
    if(review){
      if(j==q.correct)c+=" correct";
      else if(answers[i]==j)c+=" wrong";
    }
    h+=`<div class="${c}" onclick="selectA(${j})">${o}</div>`;
  });
  qContainer.innerHTML=h;renderMath();
}

function selectA(i){if(!review){answers[cur]=i;buildPalette();loadQ(cur);}}
function nextQ(){if(cur<questions.length-1)loadQ(cur+1);}
function prevQ(){if(cur>0)loadQ(cur-1);}
function toggleMark(){marked[cur]=!marked[cur];buildPalette();}

function buildPalette(){
  palette.innerHTML="";
  questions.forEach((_,i)=>{
    let b=document.createElement("button");
    b.innerText=i+1;b.className="palette-btn";
    const a=answers[i]!=null,m=marked[i];
    if(i===cur)b.classList.add("p-current");
    else if(a&&m)b.classList.add("p-marked-attempted");
    else if(a)b.classList.add("p-attempted");
    else if(m)b.classList.add("p-marked");
    b.onclick=()=>loadQ(i);
    palette.appendChild(b);
  });
}

function startTimer(){
  timerInt=setInterval(()=>{
    let m=Math.floor(time/60),s=time%60;
    timer.innerText=`${m}:${String(s).padStart(2,"0")}`;
    if(--time<0)submit();
  },1000);
}

function confirmSubmit(){if(confirm("Are you sure you want to finish the exam?"))submit();}

async function submit(){
  if(resultSaved) return;
  resultSaved=true;
  clearInterval(timerInt);
  let correct=0,wrong=0;
  questions.forEach((q,i)=>{
    if(answers[i]==q.correct)correct++;
    else if(answers[i]!=null)wrong++;
  });
  let score=correct-wrong*0.25;
  let timeTakenSec = initialTime - time;
  let tMin = Math.floor(timeTakenSec/60), tSec = timeTakenSec%60;
  let accuracy = (correct+wrong) > 0 ? ((correct/(correct+wrong))*100).toFixed(1) : 0;

  await fetch(SCRIPT_URL,{method:"POST",mode:"no-cors",
    body:JSON.stringify({name:studentName,phone:studentPhone,score,correct,wrong})});

  resultUI.innerHTML=`
    <h2 style="color:var(--success)">Test Submitted Successfully!</h2>
    <div class="insight-grid">
      <div class="insight-box"><h4>Final Score</h4><p>${score.toFixed(2)}</p></div>
      <div class="insight-box"><h4>Accuracy</h4><p>${accuracy}%</p></div>
      <div class="insight-box"><h4>Correct/Wrong</h4><p>‚úÖ ${correct} | ‚ùå ${wrong}</p></div>
      <div class="insight-box"><h4>Time Taken</h4><p>${tMin}m ${tSec}s</p></div>
    </div>
    <hr>
    <p>Would you like to review your answers or exit to the home screen?</p>
    <button class="warning" onclick="enterReview()">Review Answers</button>
    <button class="secondary" onclick="location.reload()">Exit to Home</button>
  `;
  show("result");
}

function enterReview(){
  review=true; show("exam"); loadQ(0);
  submitBtn.classList.add("hidden");
  exitReviewBtn.classList.remove("hidden");
}

function show(id){
  document.querySelectorAll(".container>div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function renderMath(){
  if(window.renderMathInElement)
    renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:true}]});
}
</script>
</body>
</html>
